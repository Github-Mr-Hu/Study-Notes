在测试开发的接口服务时，遇到了如下错误：

```Java
MySQLIntegrityConstraintViolationException: Duplicate entry '123-008' for key 'PRIMARY'
```

通过查百度，发现是因为数据表中设置了主键，主键不能重复，而自己对主键理解不深，因此对MySql主键进行了学习。

#### 1、什么是主键？

主键（PRIMARY KEY）的完整称呼是“主键约束”，是 [MySQL](http://c.biancheng.net/mysql/) 中使用最为频繁的约束。一般情况下，为了便于 DBMS 更快的查找到表中的记录，都会在表中设置一个主键。

#### 2、为什么需要主键？

“**信息**是用来消除随机不定性的东西”（香农）。人通过获得、识别自然界和社会的不同信息来区别不同事物，得以认识和改造世界。**数据**是反映客观事物属性的记录，是信息的具体表现形式。数据经过加工处理之后，就成为信息；而信息需要经过数字化转变成数据才能存储和传输。**数据库**就是用于存储数据记录的。既已如此，**记录**便是具有确定性(相对)的信息，其确定性即唯一性。我们得出第一条原因：

**1.数据记录需具有唯一性**（第一范式）

世界是由客观存在及其关系组成的。**数据**是数字化和模型化的存在关系。数据除了本身的描述价值外，其价值还在于其相互关联性。为实现关联的准确性，数据需要有对外相互关联的标识。所以体现在数据存储上，**主键**的第二作用，也是存在的第二因素即：

**2.数据需要关联**

**数据**用于描述客观实在的，本身没有意义。只有在根据主观需求组织之后，通过一定方式满足人认识事物的过程才具有了意义。所以数据需要被检索，被组织。则主键第三个作用：

**3.数据库底层索引用于检索数据所需**

#### 3、如何选择主键？

+ ##### 业务 Key VS 逻辑 Key

**业务 Key**，即使用具有业务意义的 id 作为 Key，比如使用订单流水号作为订单表的主键 Key。**逻辑 Key**，即无关业务的 Key，按某种规则生成 Key，如自增 Key。

+ ##### 业务主键

  + ###### 优点

    + Key 具有业务意义，在查询时可以直接作为搜索关键字使用
    + 不需要额外的列和索引空间
    + 可以减少一些 join 操作。

  + ###### 缺点

    + 当业务发生变化时，有时需要变更主键
    + 涉及多列 Key 时比较难操作
    + 业务 Key 往往比较长，所占空间更大，导致更大的磁盘 IO
    + 在 Key 确定前不能持久化数据，有时我们没有在确定数据 Key 时，就想先添加一条记录，之后再更新业务 Key
    + 设计一个兼具易用和性能的 Key 生成方案比较难

+ ##### 逻辑主键

  + ###### 优点

    + 不会因为业务的变动而需要修改 Key 逻辑
    + 操作简单，且易于管理
    + 逻辑 Key 往往更小，性能更优
    + 逻辑 Key 更容易保证唯一性
    + 更易于优化

  + ###### 缺点

    + 查询主键列和主键索引需要额外的磁盘空间
    + 在插入数据和更新数据时需要额外的 IO
    + 更多的 join 可能
    + 如果没有唯一性策略限制，容易出现重复的 Key
    + 测试环境和正式环境 Key 不一致，不利于排查问题
    + Key 的值没有和数据关联，不符合三范式
    + 不能用于搜索关键字
    + 依赖不同数据库系统的具体实现，不利于底层数据库的替换

#### 4、如何创建主键？

+ ##### 单字段主键

单字段主键，即将**表中的一个字段设置为主键**，在 CREATE TABLE 语句中，通过 **PRIMARY KEY** 关键字来指定主键。在定义字段的同时指定主键，语法格式如下：

```Java
<字段名> <数据类型> PRIMARY KEY [默认值]
```

或者是在定义完所有字段之后指定主键，语法格式如下

```Java
[CONSTRAINT <约束名>] PRIMARY KEY [字段名]
```

主键约束不仅可以在创建表的同时创建，也可以在修改表时添加。但是需要注意的是，设置成主键约束的字段中不允许有空值。

在修改数据表时添加主键约束的语法格式如下：

```java
ALTER TABLE <数据表名> ADD PRIMARY KEY(<字段名>);
```

通常情况下，当在修改表时要设置表中某个字段的主键约束时，要确保设置成主键约束的字段中值不能够有重复的，并且要保证是非空的。否则，无法设置主键约束。

+ ##### 联合主键

所谓的联合主键，就是这个主键是由**一张表中多个字段组成的**。

比如，设置学生选课数据表时，使用学生编号做主键还是用课程编号做主键呢？如果用学生编号做主键，那么一个学生就只能选择一门课程。如果用课程编号做主键，那么一门课程只能有一个学生来选。显然，这两种情况都是不符合实际情况的。

实际上设计学生选课表，要限定的是一个学生只能选择同一课程一次。因此，学生编号和课程编号可以放在一起共同作为主键，这也就是联合主键了。

主键由多个字段联合组成，语法格式如下：

```java
PRIMARY KEY [字段1，字段2，…,字段n]
```

**NOTE:**当主键是由多个字段组成时，不能直接在字段名后面声明主键约束。**同时在对使用联合主键的表进行插入操作时，只要保证联合主键中插入的字段值至少一个不同即可。**

#### 5、如何删除主键？

当一个表中不需要主键约束时，就需要从表中将其删除。删除主键约束的方法要比创建主键约束容易的多。

删除主键约束的语法格式如下所示：

```java
ALTER TABLE <数据表名> DROP PRIMARY KEY;
```

