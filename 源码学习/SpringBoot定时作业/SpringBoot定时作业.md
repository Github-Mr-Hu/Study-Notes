#### 前言

上周在梳理登陆密码错误限制登录次数业务流程的过程中，需求中要求每天允许连续试错次数最多为5次，且在每天凌晨12点对限制登陆的账号的登录次数计数值清零。在代码实现中考虑使用SpringBoot定时任务完成这个功能，这里对开发中的具体实现过程进行一个总结。

#### 步骤

+ ##### 添加依赖

```xml
<dependency>
     <groupId>org.springframework.boot</groupId>
     <artifactId>spring-boot-starter</artifactId>
</dependency>
```

+ ##### 启动类上加@EnableScheduling注解

```java
@EnableSwagger2
@SpringBootApplication
@EnableScheduling
public class EcopCustApplication {

	public static void main(String[] args) {
		SpringApplication.run(EcopCustApplication.class, args);
	}
}
```

+ ##### 编写定时任务要执行的代码，并把任务类和方法交有Spring IOC容器管理

```java
    /**
     * 添加定时任务，用于每天定时AM00:00:00清除所有账号的登录错误记录次数为0
     */
    @Scheduled(cron = "0 0 0  * * ?")
    public void addTimingTask() {
        Map<String, Object> uptParam = new HashMap<String, Object>();
        uptParam.put("LIMIT_COUNT", 0);
        try {
            bsSysuserDictMapper.updateByLoginNo(uptParam);
        }catch (Exception e){
            throw  new BusiException("9999", "定时更新登录错误记录次数失败");
        }
    }
```

#### 附录

##### Cron参数学习

对于定时任务的实现，除业务代码外，最终还是由`cron`表达式进行控制执行的周期。

+ ##### cron 表达式格式

cron 表达式分为七个域： 秒 分 时 日 月 周 年 每一个域之间用空格连接，不指定”年“域时，年域可以省略不写，可简写为： 秒 分 时 日 月 周。

+ ##### cron表达式七个域列表

| 名称 | 是否必须 | 允许值             | 特殊字符        |
| ---- | -------- | ------------------ | --------------- |
| 秒   | 是       | 0 - 59             | , - * /         |
| 分   | 是       | 0 - 59             | , - * /         |
| 时   | 是       | 0 - 23             | , - * /         |
| 日   | 是       | 1 - 31             | , - * ? L W C   |
| 月   | 是       | 1 - 12 / JAN - DEC | , - * /         |
| 周   | 是       | 1 - 7 / SUN - SAT  | , - * ? / L C # |
| 年   | 否       | 空 / 1970 - 2099   | , - * /         |

**NOTE: **需要注意的是“周”域中，使用数值表示时，**7表示周六，1表示周日**。

+ ##### 符号的使用

  + ##### 所有域均可用“,”，“-”，“*”，“/”

    - `,` x,y表示x和y
    - `-` x-y表示x到y
    - `*` 表示每TIME
    - `/` x/y表示从x起，每隔y

  + ##### “日”域另有“?”，“L”，“W”，“C”

    - `?` 表示不指定“日”域的值。规则是指定“周”域，则“日”域必须为“?”。反之，指定“日”域，则“周”域必须为“?”。如0 0 12 ? *MON 或 0 0 12 1* ?
    - `L` 2种写法。一，表示月末几天，如2L， 表示月末的2天。二，表示月末倒数第几天，如L-3，表示月末倒数第3天。
    - `W` 表示临近某日的工作日，如15W，表示最接近15号的工作日，可能是15号（刚好是工作日）、15号前（刚好周六）或15号后（刚好周日）。
    - `C` 表示和Calendar计划关联的值，如1C表示，1日或1日后包括Carlendar的第一天。
    - `LW` L和W的组合，只能出现在"日"域中。表示某月最后一个工作日，不一定是周五（详细见结尾PS）。

  + #####  “周”域另有“?”，“L”，“#”，“C”

    - `?` 表示不指定“周”域。规则是指定“日”域值，则“周”域值必须为“?”。反之，指定“周”域值，则“日”域值必须为“?”。如0 0 12 1 *? 或 0 0 12 ？* MON
    - `L` 表示某月的最后一个周几，如1L， 表示某月的最后一个周日（1表示周日），7L，表示某月的最后一个周六（7表示周六）。
    - `#` 只能出现在"周"域中，表示第几个周几，x#y，y表示第几个，x表示周的值，如6#2，表示第2个周五（6表示周五）。
    - `C` 表示和Calendar计划关联的值，如1C表示，周日或周日后包括Carlendar的第一天。

  **NOTE：** “日域”域中，L和W组合为“LW”时，网上有很多种定义，比如： 说法一：LW表示某月的最后一个工作日 说法二：LW某月最后一周的最后一个工作日，即周五。

+ #####  cron示例

| cron表达式               | 含义                                                         |
| ------------------------ | ------------------------------------------------------------ |
| 0 0 0 * * ?              | 每天凌晨0点执行一次                                          |
| 0 0 10,14,16 * * ?       | 每天上午10点，下午2点，4点                                   |
| 0 0/30 9-17 * * ?        | 朝九晚五工作时间内每半小时                                   |
| 0 0 12 ? * WED           | 表示每个星期三中午12点                                       |
| 0 0 12 * * ?             | 每天12点触发                                                 |
| 0 15 10 ? * *            | 每天10点15分触发                                             |
| 0 15 10 * * ? 2020       | 2020年每天10点15分触发                                       |
| 0 14 * ?                 | 每天下午的2点到2点59分每分触发                               |
| 0 0/5 14 * * ?           | 每天下午的 2点到2点59分(整点开始，每隔5分触发)               |
| 0 0/5 14,18 * * ?        | 每天下午的 2点到2点59分、18点到18点59分(整点开始，每隔5分触发) |
| 0 0-5 14 * * ?           | 每天下午的 2点到2点05分每分触发                              |
| 0 10,44 14 ? 3 WED       | 3月每周三下午的 2点10分和2点44分触发                         |
| 0 15 10 ? * MON-FRI      | 从周一到周五每天上午的10点15分触发                           |
| 0 15 10 15 * ?           | 每月15号上午10点15分触发                                     |
| 0 15 10 L * ?            | 每月最后一天的10点15分触发                                   |
| 0 15 10 ? * 6L           | 每月最后一周的星期五的10点15分触发                           |
| 0 15 10 ? * 6L 2002-2020 | 从2002年到2020年每月最后一周的星期五的10点15分触发           |
| 0 15 10 ? * 6#3          | 每月的第三周的星期五开始触发                                 |
| 0 0 12 1/5 * ?           | 每月的第一个中午开始每隔5天触发一次                          |
| 0 11 11 11 11 ?          | 每年的11月11号 11点11分触发(光棍节)                          |

+ ##### cron表达式在线生成工具

[cron表达式在线生成工具](http://www.pppet.net/)（熟练掌握Cron参数的用法后，可使用以节省时间；刚入门是推荐还是自己写来解加深理解）

